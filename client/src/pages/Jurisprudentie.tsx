import { useState } from "react";
import { useAuth } from "@/hooks/useAuth";
import { Button } from "@/components/ui/button";
import { Link } from "wouter";
import { ArrowLeft, Scale, FileText, ExternalLink, Calendar, Building2, Search, Loader2, Sparkles, Settings } from "lucide-react";
import { useActiveCase } from "@/contexts/CaseContext";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import { useMutation } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";

interface VectorSearchResult {
  id: string;
  score: number;
  ecli: string;
  title?: string;
  court?: string;
  decision_date?: string;
  legal_area?: string;
  procedure_type?: string;
  source_url?: string;
  text?: string;
  ai_feiten?: string;
  ai_geschil?: string;
  ai_beslissing?: string;
  ai_motivering?: string;
  ai_inhoudsindicatie?: string;
}

export default function Jurisprudentie() {
  const { isLoading: authLoading } = useAuth();
  const currentCase = useActiveCase();
  const { toast } = useToast();
  
  const [searchQuery, setSearchQuery] = useState("");
  const [legalArea, setLegalArea] = useState<string | undefined>(undefined);
  const [court, setCourt] = useState<string | undefined>(undefined);
  const [procedureType, setProcedureType] = useState<string | undefined>(undefined);
  const [results, setResults] = useState<VectorSearchResult[]>([]);
  const [autoGeneratedQuery, setAutoGeneratedQuery] = useState("");
  const [expandedResult, setExpandedResult] = useState<string | null>(null);
  
  // Advanced search settings
  const [topK, setTopK] = useState(20);
  const [scoreThreshold, setScoreThreshold] = useState(0.01);
  const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
  const [maxResults, setMaxResults] = useState<number | null>(null); // Limit displayed results
  const [requiredKeywords, setRequiredKeywords] = useState(""); // Must-contain keywords

  const generateQueryMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('POST', '/api/pinecone/generate-query', {
        caseId: currentCase?.id
      });
      return response.json();
    },
    onSuccess: (data: any) => {
      setAutoGeneratedQuery(data.query);
      setSearchQuery(data.query);
      
      // Set required keywords if generated by AI
      if (data.requiredKeywords && Array.isArray(data.requiredKeywords) && data.requiredKeywords.length > 0) {
        setRequiredKeywords(data.requiredKeywords.join(', '));
        toast({
          title: "AI zoekvraag en verplichte woorden gegenereerd",
          description: `Zoekvraag en ${data.requiredKeywords.length} verplichte ${data.requiredKeywords.length === 1 ? 'woord' : 'woorden'} ingesteld voor optimale resultaten`,
        });
      } else {
        toast({
          title: "AI zoekvraag gegenereerd",
          description: "De zoekvraag is automatisch gegenereerd op basis van uw juridisch advies",
        });
      }
    },
    onError: (error: any) => {
      toast({
        title: "Fout bij genereren",
        description: error.message || "Kon geen zoekvraag genereren",
        variant: "destructive",
      });
    }
  });

  const searchMutation = useMutation({
    mutationFn: async () => {
      // Debug logging
      console.log('üîç Search mutation started');
      console.log('üìù Search query:', searchQuery);
      console.log('üîë Required keywords state:', `"${requiredKeywords}"`);
      console.log('üîë Required keywords trimmed:', `"${requiredKeywords.trim()}"`);
      console.log('üîë Will apply filter:', requiredKeywords.trim() !== '');
      
      const filters: Record<string, any> = {};
      
      if (legalArea) filters.legal_area = { $eq: legalArea };
      if (court) filters.court = { $eq: court };
      if (procedureType) filters.procedure_type = { $eq: procedureType };

      const response = await apiRequest('POST', '/api/pinecone/search', {
        query: searchQuery,
        filters: Object.keys(filters).length > 0 ? filters : undefined,
        topK: topK,
        scoreThreshold: scoreThreshold
      });
      return response.json();
    },
    onSuccess: (data: any) => {
      let filteredResults = data.results || [];
      
      console.log('üìä Backend returned:', data.results?.length || 0, 'results');
      console.log('üîë Applying required keywords filter with:', `"${requiredKeywords}"`);
      
      // Apply required keywords filter (case-insensitive)
      if (requiredKeywords.trim()) {
        const keywords = requiredKeywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k);
        console.log('üîë Parsed keywords:', keywords);
        
        filteredResults = filteredResults.filter((result: VectorSearchResult) => {
          const searchText = [
            result.text,
            result.ai_inhoudsindicatie,
            result.ai_feiten,
            result.ai_geschil,
            result.ai_beslissing,
            result.ai_motivering,
            result.title
          ].join(' ').toLowerCase();
          
          // All keywords must be present
          const matches = keywords.every(keyword => searchText.includes(keyword));
          if (!matches) {
            console.log('‚ùå Filtered out result (missing keywords):', result.ecli);
          }
          return matches;
        });
        console.log(`‚úÖ After keyword filter: ${filteredResults.length}/${data.results?.length || 0} results`);
      } else {
        console.log('‚ÑπÔ∏è No keyword filter applied (requiredKeywords is empty)');
      }
      
      setResults(filteredResults);
      
      const totalResults = data.results?.length || 0;
      const afterFilter = filteredResults.length;
      
      if (requiredKeywords.trim() && totalResults !== afterFilter) {
        toast({
          title: "Zoekresultaten gefilterd",
          description: `${afterFilter} van ${totalResults} uitspraken bevatten de verplichte woorden`,
        });
      } else {
        toast({
          title: "Zoekresultaten geladen",
          description: `${afterFilter} relevante uitspraken gevonden`,
        });
      }
    },
    onError: (error: any) => {
      toast({
        title: "Fout bij zoeken",
        description: error.message || "Kon niet zoeken in database",
        variant: "destructive",
      });
    }
  });

  const handleSearch = () => {
    if (!searchQuery.trim()) {
      toast({
        title: "Geen zoekvraag",
        description: "Voer een zoekvraag in om te zoeken",
        variant: "destructive",
      });
      return;
    }
    searchMutation.mutate();
  };

  if (authLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
          <p className="mt-4 text-muted-foreground">Laden...</p>
        </div>
      </div>
    );
  }

  if (!currentCase) {
    return (
      <div className="text-center py-12">
        <div className="max-w-md mx-auto">
          <h2 className="text-2xl font-bold text-foreground mb-4">Geen actieve zaak</h2>
          <p className="text-muted-foreground mb-6">
            U heeft nog geen zaak aangemaakt.
          </p>
          <Button asChild size="lg" data-testid="button-create-first-case">
            <Link href="/new-case">
              Eerste zaak starten
            </Link>
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <Button variant="ghost" asChild className="mb-4" data-testid="button-back-to-analysis">
        <Link href="/analysis">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Terug naar analyse
        </Link>
      </Button>

      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">Jurisprudentie</h1>
        <p className="text-muted-foreground">
          Zoek relevante rechterlijke uitspraken voor {currentCase.title || 'uw zaak'}
        </p>
      </div>

      {/* Search form */}
      <Card className="mb-6" data-testid="card-search-filters">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Sparkles className="h-5 w-5" />
            Semantisch zoeken in jurisprudentie
          </CardTitle>
          <CardDescription>
            Doorzoek de volledige tekst van Nederlandse rechterlijke uitspraken met AI-powered semantische zoekopdrachten
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div>
              <Label htmlFor="searchQuery">Zoekvraag</Label>
              <Input 
                id="searchQuery"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Bijvoorbeeld: ontbinding huurovereenkomst wegens geluidsoverlast"
                data-testid="input-search-query"
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handleSearch();
                  }
                }}
                className="text-base"
              />
              <p className="text-xs text-muted-foreground mt-1">
                Beschrijf uw juridische vraag in natuurlijke taal
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <Label htmlFor="legal-area">Rechtsgebied (optioneel)</Label>
                <Select value={legalArea} onValueChange={(value) => setLegalArea(value === "all" ? undefined : value)}>
                  <SelectTrigger id="legal-area" data-testid="select-legal-area">
                    <SelectValue placeholder="Alle rechtsgebieden" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Alle rechtsgebieden</SelectItem>
                    <SelectItem value="Civiel recht">Civiel recht</SelectItem>
                    <SelectItem value="Bestuursrecht">Bestuursrecht</SelectItem>
                    <SelectItem value="Strafrecht">Strafrecht</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="court">Rechtbank (optioneel)</Label>
                <Select value={court} onValueChange={(value) => setCourt(value === "all" ? undefined : value)}>
                  <SelectTrigger id="court" data-testid="select-court">
                    <SelectValue placeholder="Alle rechtbanken" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Alle rechtbanken</SelectItem>
                    <SelectItem value="Hoge Raad">Hoge Raad</SelectItem>
                    <SelectItem value="Rechtbank Amsterdam">Rechtbank Amsterdam</SelectItem>
                    <SelectItem value="Rechtbank Rotterdam">Rechtbank Rotterdam</SelectItem>
                    <SelectItem value="Rechtbank Den Haag">Rechtbank Den Haag</SelectItem>
                    <SelectItem value="Rechtbank Utrecht">Rechtbank Utrecht</SelectItem>
                    <SelectItem value="Gerechtshof Amsterdam">Gerechtshof Amsterdam</SelectItem>
                    <SelectItem value="Gerechtshof Den Haag">Gerechtshof Den Haag</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="procedure-type">Procedure type (optioneel)</Label>
                <Select value={procedureType} onValueChange={(value) => setProcedureType(value === "all" ? undefined : value)}>
                  <SelectTrigger id="procedure-type" data-testid="select-procedure-type">
                    <SelectValue placeholder="Alle procedures" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Alle procedures</SelectItem>
                    <SelectItem value="Bodemzaak">Bodemzaak</SelectItem>
                    <SelectItem value="Kort geding">Kort geding</SelectItem>
                    <SelectItem value="Hoger beroep">Hoger beroep</SelectItem>
                    <SelectItem value="Cassatie">Cassatie</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Advanced Settings */}
            <Collapsible open={showAdvancedSettings} onOpenChange={setShowAdvancedSettings}>
              <CollapsibleTrigger asChild>
                <Button 
                  variant="outline" 
                  className="w-full md:w-auto gap-2"
                  data-testid="button-toggle-advanced-settings"
                >
                  <Settings className="h-4 w-4" />
                  Geavanceerde instellingen
                  <span className="text-xs text-muted-foreground ml-2">
                    ({showAdvancedSettings ? 'verbergen' : 'tonen'})
                  </span>
                </Button>
              </CollapsibleTrigger>
              <CollapsibleContent className="mt-4 space-y-6">
                <div className="border rounded-lg p-4 bg-muted/30 space-y-4">
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label htmlFor="topK" className="font-semibold">Maximum aantal resultaten</Label>
                      <span className="text-sm font-mono bg-primary/10 px-2 py-1 rounded">{topK}</span>
                    </div>
                    <Slider
                      id="topK"
                      min={5}
                      max={50}
                      step={5}
                      value={[topK]}
                      onValueChange={(value) => setTopK(value[0])}
                      data-testid="slider-topk"
                      className="w-full"
                    />
                    <p className="text-xs text-muted-foreground">
                      Beperk het aantal resultaten dat Pinecone retourneert (5-50)
                    </p>
                  </div>

                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label htmlFor="scoreThreshold" className="font-semibold">Relevantie drempel (score)</Label>
                      <span className="text-sm font-mono bg-primary/10 px-2 py-1 rounded">{(scoreThreshold * 100).toFixed(1)}%</span>
                    </div>
                    <Slider
                      id="scoreThreshold"
                      min={0}
                      max={0.1}
                      step={0.001}
                      value={[scoreThreshold]}
                      onValueChange={(value) => setScoreThreshold(value[0])}
                      data-testid="slider-score-threshold"
                      className="w-full"
                    />
                    <p className="text-xs text-muted-foreground">
                      Minimale similarity score voor resultaten. Hogere waarde = strengere filtering (0.0% - 10.0%)
                    </p>
                  </div>

                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label htmlFor="maxResults" className="font-semibold">Toon alleen top resultaten</Label>
                      <span className="text-sm font-mono bg-primary/10 px-2 py-1 rounded">
                        {maxResults || 'alle'}
                      </span>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        variant={maxResults === null ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMaxResults(null)}
                        data-testid="button-show-all"
                      >
                        Alle
                      </Button>
                      <Button
                        variant={maxResults === 3 ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMaxResults(3)}
                        data-testid="button-show-top3"
                      >
                        Top 3
                      </Button>
                      <Button
                        variant={maxResults === 5 ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMaxResults(5)}
                        data-testid="button-show-top5"
                      >
                        Top 5
                      </Button>
                      <Button
                        variant={maxResults === 10 ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMaxResults(10)}
                        data-testid="button-show-top10"
                      >
                        Top 10
                      </Button>
                    </div>
                    <p className="text-xs text-muted-foreground">
                      Beperk weergave tot alleen de meest relevante resultaten
                    </p>
                  </div>

                  <div className="space-y-3">
                    <Label htmlFor="requiredKeywords" className="font-semibold">
                      Verplichte woorden (exact match)
                      <span className="ml-2 text-xs font-normal text-muted-foreground">(optioneel)</span>
                    </Label>
                    <Input
                      id="requiredKeywords"
                      value={requiredKeywords}
                      onChange={(e) => setRequiredKeywords(e.target.value)}
                      placeholder='Bijvoorbeeld: huurovereenkomst, merkinbreuk'
                      data-testid="input-required-keywords"
                      className="text-sm"
                    />
                    <p className="text-xs text-muted-foreground">
                      Alleen resultaten die deze woorden bevatten worden getoond. Scheid meerdere woorden met een komma. Hoofdletter-ongevoelig. Bij automatisch zoeken worden deze woorden door AI gegenereerd.
                    </p>
                  </div>

                  <div className="bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded p-3">
                    <p className="text-xs text-blue-900 dark:text-blue-100">
                      <strong>üí° Tip:</strong> Voor strengere filtering verhoog de threshold naar 3-5%. Gebruik "Verplichte woorden" voor exacte termen (bijv. bedrijfsnamen, artikel nummers). Combineer beide voor maximale precisie.
                    </p>
                  </div>
                </div>
              </CollapsibleContent>
            </Collapsible>

            <Button 
              onClick={handleSearch} 
              disabled={searchMutation.isPending || !searchQuery.trim()}
              data-testid="button-search"
              className="w-full md:w-auto"
              size="lg"
            >
              {searchMutation.isPending ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Zoeken...
                </>
              ) : (
                <>
                  <Search className="mr-2 h-4 w-4" />
                  Zoeken in jurisprudentie
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Automatic Jurisprudence Search */}
      <Card className="mb-6" data-testid="card-auto-search">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Sparkles className="h-5 w-5 text-primary" />
            Automatische Jurisprudentie Zoekopdracht
          </CardTitle>
          <CardDescription>
            Laat AI een geoptimaliseerde zoekvraag genereren op basis van uw volledige juridisch advies om relevante rechtspraak te vinden die uw rechtspositie versterkt
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="bg-primary/5 border border-primary/20 rounded-lg p-4">
              <div className="flex items-start gap-3 mb-3">
                <Sparkles className="h-5 w-5 text-primary mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <h4 className="font-semibold text-sm mb-1">Hoe werkt dit?</h4>
                  <p className="text-xs text-muted-foreground leading-relaxed">
                    AI analyseert uw juridisch advies (feiten, geschil, juridische duiding) en genereert een geoptimaliseerde zoekopdracht 
                    die specifiek gericht is op het vinden van jurisprudentie die uw rechtspositie ondersteunt en uw kans op succes vergroot.
                  </p>
                </div>
              </div>
            </div>

            <div>
              <Label htmlFor="autoQuery">AI-gegenereerde zoekvraag</Label>
              <div className="flex gap-2">
                <Input 
                  id="autoQuery"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Klik op 'Genereer Zoekvraag' om AI een optimale zoekvraag te laten maken"
                  data-testid="input-auto-query"
                  className="text-base flex-1"
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && searchQuery.trim()) {
                      handleSearch();
                    }
                  }}
                />
                <Button
                  onClick={() => generateQueryMutation.mutate()}
                  disabled={generateQueryMutation.isPending || !currentCase}
                  data-testid="button-generate-query"
                  variant="secondary"
                  size="lg"
                >
                  {generateQueryMutation.isPending ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Genereren...
                    </>
                  ) : (
                    <>
                      <Sparkles className="mr-2 h-4 w-4" />
                      Genereer Zoekvraag
                    </>
                  )}
                </Button>
              </div>
              <p className="text-xs text-muted-foreground mt-1">
                De AI analyseert uw juridisch advies en stelt automatisch de meest effectieve zoekvraag √©n verplichte kernwoorden in
              </p>
            </div>

            {searchQuery.trim() && (
              <Button 
                onClick={handleSearch} 
                disabled={searchMutation.isPending}
                data-testid="button-auto-search"
                className="w-full"
                size="lg"
              >
                {searchMutation.isPending ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Zoeken...
                  </>
                ) : (
                  <>
                    <Search className="mr-2 h-4 w-4" />
                    Zoeken met deze vraag
                  </>
                )}
              </Button>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Results */}
      {results.length > 0 && (
        <div className="mb-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-semibold flex items-center gap-2">
              <Sparkles className="h-5 w-5" />
              {maxResults && results.length > maxResults 
                ? `${maxResults} van ${results.length} uitspraken getoond (top resultaten)`
                : `${results.length} relevante ${results.length === 1 ? 'uitspraak' : 'uitspraken'} gevonden`
              }
            </h2>
          </div>

          <div className="space-y-4">
            {(maxResults ? results.slice(0, maxResults) : results).map((result, index) => (
              <Card key={result.id} data-testid={`card-result-${index}`}>
                <CardHeader>
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      <CardTitle className="text-lg mb-2">
                        {result.title || result.ecli}
                      </CardTitle>
                      <div className="flex flex-wrap gap-2 mb-2">
                        {result.court && (
                          <Badge variant="secondary" className="text-xs">
                            <Building2 className="h-3 w-3 mr-1" />
                            {result.court}
                          </Badge>
                        )}
                        {result.decision_date && (
                          <Badge variant="outline" className="text-xs">
                            <Calendar className="h-3 w-3 mr-1" />
                            {result.decision_date}
                          </Badge>
                        )}
                        {result.legal_area && (
                          <Badge variant="outline" className="text-xs">
                            <Scale className="h-3 w-3 mr-1" />
                            {result.legal_area}
                          </Badge>
                        )}
                        {result.procedure_type && (
                          <Badge variant="outline" className="text-xs">
                            {result.procedure_type}
                          </Badge>
                        )}
                      </div>
                      <p className="text-xs text-muted-foreground font-mono">
                        {result.ecli}
                      </p>
                    </div>
                    {result.source_url && (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        asChild
                        data-testid={`button-view-${index}`}
                      >
                        <a 
                          href={result.source_url} 
                          target="_blank" 
                          rel="noopener noreferrer"
                        >
                          <ExternalLink className="h-4 w-4 mr-2" />
                          Bekijk op Rechtspraak.nl
                        </a>
                      </Button>
                    )}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {/* AI Samenvatting */}
                    {(result.ai_inhoudsindicatie || result.ai_feiten || result.ai_geschil || result.ai_beslissing || result.ai_motivering) && (
                      <div className="bg-primary/5 p-4 rounded-lg border border-primary/10">
                        <div className="flex items-center gap-2 mb-3">
                          <Sparkles className="h-4 w-4 text-primary" />
                          <h4 className="font-semibold text-sm">AI Samenvatting</h4>
                        </div>
                        <div className="prose prose-sm max-w-none text-sm">
                          {expandedResult === result.id ? (
                            // Show full summary
                            <div className="space-y-4">
                              {result.ai_inhoudsindicatie && (
                                <div>
                                  <h5 className="font-semibold mb-1">Inhoudsindicatie</h5>
                                  <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                    {result.ai_inhoudsindicatie}
                                  </p>
                                </div>
                              )}
                              {result.ai_feiten && (
                                <div>
                                  <h5 className="font-semibold mb-1">Feiten</h5>
                                  <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                    {result.ai_feiten}
                                  </p>
                                </div>
                              )}
                              {result.ai_geschil && (
                                <div>
                                  <h5 className="font-semibold mb-1">Geschil</h5>
                                  <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                    {result.ai_geschil}
                                  </p>
                                </div>
                              )}
                              {result.ai_beslissing && (
                                <div>
                                  <h5 className="font-semibold mb-1">Beslissing</h5>
                                  <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                    {result.ai_beslissing}
                                  </p>
                                </div>
                              )}
                              {result.ai_motivering && (
                                <div>
                                  <h5 className="font-semibold mb-1">Motivering</h5>
                                  <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                    {result.ai_motivering}
                                  </p>
                                </div>
                              )}
                              <Button
                                variant="link"
                                size="sm"
                                className="p-0 h-auto text-primary"
                                onClick={() => setExpandedResult(null)}
                                data-testid={`button-collapse-${index}`}
                              >
                                Minder tonen
                              </Button>
                            </div>
                          ) : (
                            // Show first 2 lines
                            <div>
                              {(() => {
                                const fullText = [
                                  result.ai_inhoudsindicatie,
                                  result.ai_feiten,
                                  result.ai_geschil,
                                  result.ai_beslissing,
                                  result.ai_motivering
                                ].filter(Boolean).join('\n\n');
                                
                                const lines = fullText.split('\n').filter(l => l.trim());
                                const preview = lines.slice(0, 2).join('\n');
                                
                                return (
                                  <>
                                    <p className="text-muted-foreground whitespace-pre-wrap leading-relaxed">
                                      {preview}
                                    </p>
                                    {lines.length > 2 && (
                                      <Button
                                        variant="link"
                                        size="sm"
                                        className="p-0 h-auto text-primary mt-2"
                                        onClick={() => setExpandedResult(result.id)}
                                        data-testid={`button-expand-${index}`}
                                      >
                                        Verder lezen ‚Üí
                                      </Button>
                                    )}
                                  </>
                                );
                              })()}
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}

      {!results.length && !searchMutation.isPending && (
        <Card data-testid="card-jurisprudentie-empty">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Scale className="h-5 w-5" />
              Zoeken in jurisprudentie
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-center py-12">
              <FileText className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-xl font-semibold mb-2">Nog geen jurisprudentie gezocht</h3>
              <p className="text-sm text-muted-foreground max-w-md mx-auto">
                Gebruik de zoekopdracht hierboven om relevante rechterlijke uitspraken te vinden met AI-powered semantische zoekopdrachten.
              </p>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
